# üìä Monitoring Module (10-monitoring)

## Purpose

This module implements comprehensive system monitoring and log aggregation using Logwatch and log rotation policies. It provides automated analysis of system logs, alerting administrators to important events, and ensures critical logs are preserved for forensic analysis and compliance.

## üîó Dependencies

- logwatch: Log analysis and reporting tool
- logrotate: Log rotation and management
- gzip: Compression for archived logs
- crond/systemd-timer: Scheduled task execution
- mailutils: Email delivery for Logwatch reports
- grep/awk/sed: Log parsing utilities

## ‚öôÔ∏è Configuration

### Logwatch Configuration

A. **Email Reporting**
   - Frequency: Daily (default)
   - Time: Early morning (typically 6 AM)
   - Recipient: System administrator email
   - Format: Detailed analysis with statistics
   - Detail level: Medium (customizable)

B. **Log Sources**
   - System logs: `/var/log/syslog`, `/var/log/auth.log`
   - SSH logs: `/var/log/auth.log` (login attempts, authentications)
   - Firewall logs: `/var/log/ufw.log` (UFW rule violations)
   - Application logs: `/var/log/firstboot/*.log` (module execution)
   - Mail logs: `/var/log/mail.log` (mail delivery events)
   - Fail2ban: `/var/log/fail2ban.log` (intrusion attempts)

C. **Report Details**
   - Failed login attempts and patterns
   - Firewall rejections and anomalies
   - Service restarts and errors
   - Cron job execution results
   - Security-related events summary

### Log Rotation Policies

A. **Default Rotation**
   - Frequency: Daily for critical logs, weekly for others
   - Retention: 14 days for regular logs, 30 days for security
   - Compression: gzip (saves ~90% space for text logs)
   - Permissions: 0640 (readable by admin, not world-visible)

B. **Log-Specific Policies**
   - `/var/log/auth.log`: Daily rotation, 30-day retention, encrypted storage recommended
   - `/var/log/syslog`: Daily rotation, 14-day retention
   - `/var/log/ufw.log`: Weekly rotation, 30-day retention (security-sensitive)
   - `/var/log/fail2ban.log`: Daily rotation, 30-day retention (security-sensitive)
   - `/var/log/firstboot/*.log`: Monthly rotation, 60-day retention (compliance)

## üö® Error Handling

### Common Errors

A. Logwatch fails to send email
   - Cause: Postfix not running or relay misconfigured
   - Solution: Verify mail module (9-mail_config) completed; check Postfix status
   - Prevention: Run 9-mail_config module before 10-monitoring

B. Log rotation fails
   - Cause: Permission denied or disk full
   - Solution: Check file permissions; free up disk space
   - Prevention: Monitor disk usage; ensure proper permissions on log directories

C. Logwatch cron job not running
   - Cause: Cron service not active or crontab syntax error
   - Solution: Enable cron service; check crontab entry with crontab -l
   - Prevention: Verify cron enabled at boot

D. Log file growth exceeds storage
   - Cause: Logs not rotating or retention too long
   - Solution: Force log rotation: logrotate -f /etc/logrotate.conf
   - Prevention: Adjust rotation frequency or retention periods

## üîÑ Integration

### Input

- System logs (generated by kernel, services, applications)
- Mail server configuration (from 9-mail_config for email delivery)
- Firewall rules (from 5-firewall_config for log paths)
- Fail2ban configuration (from 6-fail2ban for intrusion logs)
- All module execution logs (from 0-10 modules)

### Output

- Daily Logwatch email reports to administrator
- Archived and compressed logs in /var/log/
- Logrotate executing on schedule
- Monitoring status in logs
- Long-term log retention for compliance

### Module Interactions

- **Upstream**: All modules 0-9 (generate logs), 9-mail_config (mail delivery), 6-fail2ban (intrusion logs), 5-firewall_config (firewall logs)
- **Downstream**: System administrators receive email reports; incident response uses archived logs

## üìä Validation

### Success Criteria

- Logwatch installed and configured
- Daily Logwatch email received at configured address
- Log rotation active and on schedule
- Archived logs present in /var/log/ directories
- No rotation errors in system logs
- Log files readable by admin user
- Critical logs retained for 30+ days

### Performance Metrics

- Logwatch analysis time (typically 5-30 seconds)
- Email delivery time (< 1 minute from report generation)
- Log rotation time per file (< 5 seconds)
- Disk space saved by compression (80-90% reduction typical)

### Validation Commands

```bash
systemctl status cron
crontab -l
tail -f /var/log/mail.log | grep logwatch
ls -lh /var/log/ | grep .gz
logrotate -d /etc/logrotate.conf
journalctl -u logwatch.service
```

## üßπ Cleanup

### Temporary Files

- None (log rotation preserves all files with compression)

### Configuration Files

- `/etc/logrotate.conf` ‚Äî Main logrotate configuration
- `/etc/logrotate.d/` ‚Äî Service-specific rotation rules
- `/etc/logwatch/` ‚Äî Logwatch configuration and filters
- `/etc/cron.daily/logwatch` ‚Äî Daily Logwatch execution script

### Backup & Recovery

- Backup location: `/var/log/firstboot/monitoring-config.bak`
- Log archive: Stored in /var/log/ with .gz compression
- Recovery: Restore config files; decompress archived logs if needed: `gzip -d /var/log/filename.gz`

## üìù Logging

### Log Files

- `/var/log/firstboot/10-monitoring.log` ‚Äî Module installation and configuration
- `/var/log/syslog` ‚Äî System events and Logwatch scheduling
- `/var/log/mail.log` ‚Äî Logwatch email delivery status
- Logwatch reports: Received via email with timestamp

### Log Levels

- INFO: Logwatch execution start/end, report generation, rotation completion
- WARNING: Rotation delays, email delivery slowness
- ERROR: Email delivery failure, rotation permission issues, missing log files

## üîß Maintenance

### Regular Tasks

- Review daily Logwatch email reports for anomalies
- Monitor disk usage (ensure logs don't exceed threshold)
- Verify log rotation happening on schedule
- Check for unrotated logs exceeding size limits
- Archive critical security logs to separate storage

### Typical Updates

- Adjust Logwatch detail level if reports too verbose/sparse
- Add new log sources as services added (e.g., custom app logs)
- Increase retention period for compliance requirements
- Enable/disable specific log analysis filters
- Change email recipient if admin changes

### Log Retrieval

```bash
# View current logs
tail -f /var/log/syslog

# Search archived logs
zgrep "error" /var/log/syslog.1.gz

# Decompress log for analysis
gzip -d /var/log/syslog.2.gz
gzip /var/log/syslog.2

# Check oldest logs
ls -lht /var/log/ | tail -20

# Calculate log directory size
du -sh /var/log/
```

---

**Module Type:** Operations ‚Äî Monitoring & Logging  
**Execution Order:** Tenth (10)  
**Profile Availability:** Basic, Standard, Advanced  
**Configuration:** Automatic with email delivery setup  
**Service Integration:** Logwatch, logrotate, cron, mail delivery


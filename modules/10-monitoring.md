# ðŸ“Š Monitoring Module (10-monitoring)

## ðŸŽ¯ Purpose

This module implements three critical security monitoring components per NSA Network Infrastructure Security Guide:

1. **File Integrity Monitoring (AIDE)** â€” Sec 3.1: Detect unauthorized system file modifications
2. **Centralized Logging (rsyslog)** â€” Sec 6.1: Forward logs to remote syslog server for protection against tampering
3. **Time Synchronization (NTP)** â€” Sec 6.2: Ensure accurate log timestamps via Chrony NTP client

Together, these provide:
- âœ… Tamper detection via AIDE baseline + daily verification
- âœ… Centralized audit trail for forensics and compliance
- âœ… Reliable timestamps for correlation across systems

## ðŸ”— Dependencies

- **aide, aide-common** â€” File integrity monitoring and database tools
- **chrony** â€” NTP client for time synchronization (RFC 5905)
- **rsyslog** â€” System logging daemon with remote forwarding (RFC 5424)
- **cron** â€” Scheduled task execution for daily AIDE checks
- **internet access** â€” Required for NTP pool.ntp.org (UDP port 123)

## âš™ï¸ Configuration

### A. AIDE File Integrity Monitoring (NSA Sec 3.1)

**Baseline Initialization:**
```bash
aideinit      # Create initial database
# Database location: /var/lib/aide/aide.db.new â†’ /var/lib/aide/aide.db
```

**Monitored Paths:**
```
/boot   R     # Read-only check (size, MD5, SHA256)
/etc    R
/sbin   R
/usr/sbin R
/usr/bin R
/lib    R
/lib64  R
```

**Daily Verification:**
- **Schedule:** Cron: `/etc/cron.daily/aide-check`
- **Action:** `aide --check` compares filesystem against baseline
- **Output:** `/var/log/firstboot/aide-daily.log`
- **Alerts:** On mismatch, log and alert administrator

**Detection Includes:**
- File additions/deletions in critical paths
- Permission changes (mode, owner, group)
- Content modifications (MD5/SHA256 hash)
- Link changes

### B. Centralized Rsyslog Logging (NSA Sec 6.1)

**Configuration:**
- **File:** `/etc/rsyslog.d/50-remote.conf`
- **Target:** Remote syslog server via TCP (@@) for reliability
- **Queue:** LinkedList queue with persistent save on shutdown
- **Backup:** Local copy to `/var/log/firstboot/syslog-backup.log`

**Forwarded Logs:**
```
*.* @@remote-syslog-server:514
```

**Reliability Features:**
- Queued delivery (RFC 5424, RFC 3195)
- Fallback to local backup if server unavailable
- Automatic resume retry on connection recovery

**Server Configuration (example):**
```bash
# On centralized syslog server
# Listen on port 514 (TCP)
cat >> /etc/rsyslog.conf <<EOF
# Listen on TCP 514
input(type="imtcp" port="514")

# Store forwarded logs
:hostname, isequal, "client-hostname" /var/log/remote/client.log
EOF
systemctl restart rsyslog
```

### C. NTP Time Synchronization (NSA Sec 6.2)

**Client Configuration:**
- **Service:** Chrony (lighter than NTP daemon)
- **NTP Servers:**
  - Primary: `pool.ntp.org` (load-balanced pool, 4 sources max)
  - Fallback: `time.nist.gov`, `time.cloudflare.com`
- **Sync Settings:**
  - `makestep 1.0 3` â€” Allow large corrections during boot
  - `iburst` â€” Faster sync at startup

**Configuration File:**
- **Path:** `/etc/chrony/chrony.conf`
- **Service:** `systemctl enable --now chrony`

**Verification:**
```bash
chronyc tracking        # Show sync status
chronyc sources -v      # Show server connections
timedatectl            # System time status
```

## ðŸš¨ Error Handling

| Error | Cause | Solution | Prevention |
|-------|-------|----------|-----------|
| **AIDE init fails** | Disk space or permissions | Free disk space; check `/var/lib/aide/` perms | Monitor disk during aideinit |
| **Chrony won't sync** | Network blocked or bad NTP server | Check `chronyc sources`; verify firewall allows UDP 123 | Ensure outbound UDP 123 allowed |
| **rsyslog forwarding fails** | Server unreachable or blocked | Check `systemctl status rsyslog`; verify server listening | Local backup logs to `/var/log/firstboot/` |
| **Daily AIDE cron fails** | Database corrupted or perms changed | Reinitialize AIDE; check `/var/lib/aide/` ownership | Protect AIDE DB with immutable flag |
| **Time drift detected** | NTP server issues or network problems | Check `chronyc tracking`; add fallback servers | Multiple NTP sources per NSA |

**Rollback:**
```bash
# If module fails mid-execution:
systemctl stop chrony rsyslog
rm /etc/rsyslog.d/50-remote.conf
rm /var/lib/aide/aide.db         # Force re-initialization on retry
systemctl restart chrony rsyslog
```

## ðŸ”„ Integration

### Input

- System logs (generated by kernel, services, applications)
- Mail server configuration (from 9-mail_config for email delivery)
- Firewall rules (from 5-firewall_config for log paths)
- Fail2ban configuration (from 6-fail2ban for intrusion logs)
- All module execution logs (from 0-10 modules)

### Output

- Daily Logwatch email reports to administrator
- Archived and compressed logs in /var/log/
- Logrotate executing on schedule
- Monitoring status in logs
- Long-term log retention for compliance

### Module Interactions

- **Upstream**: All modules 0-9 (generate logs), 9-mail_config (mail delivery), 6-fail2ban (intrusion logs), 5-firewall_config (firewall logs)
- **Downstream**: System administrators receive email reports; incident response uses archived logs

## ðŸ“Š Validation

### Success Criteria

- Logwatch installed and configured
- Daily Logwatch email received at configured address
- Log rotation active and on schedule
- Archived logs present in /var/log/ directories
- No rotation errors in system logs
- Log files readable by admin user
- Critical logs retained for 30+ days

### Performance Metrics

- Logwatch analysis time (typically 5-30 seconds)
- Email delivery time (< 1 minute from report generation)
- Log rotation time per file (< 5 seconds)
- Disk space saved by compression (80-90% reduction typical)

### Validation Commands

```bash
systemctl status cron
crontab -l
tail -f /var/log/mail.log | grep logwatch
ls -lh /var/log/ | grep .gz
logrotate -d /etc/logrotate.conf
journalctl -u logwatch.service
```

## ðŸ§¹ Cleanup

### Temporary Files

- None (log rotation preserves all files with compression)

### Configuration Files

- `/etc/logrotate.conf` â€” Main logrotate configuration
- `/etc/logrotate.d/` â€” Service-specific rotation rules
- `/etc/logwatch/` â€” Logwatch configuration and filters
- `/etc/cron.daily/logwatch` â€” Daily Logwatch execution script

### Backup & Recovery

- Backup location: `/var/log/firstboot/monitoring-config.bak`
- Log archive: Stored in /var/log/ with .gz compression
- Recovery: Restore config files; decompress archived logs if needed: `gzip -d /var/log/filename.gz`

## ðŸ“ Logging

### Log Files

- `/var/log/firstboot/10-monitoring.log` â€” Module installation and configuration
- `/var/log/syslog` â€” System events and Logwatch scheduling
- `/var/log/mail.log` â€” Logwatch email delivery status
- Logwatch reports: Received via email with timestamp

### Log Levels

- INFO: Logwatch execution start/end, report generation, rotation completion
- WARNING: Rotation delays, email delivery slowness
- ERROR: Email delivery failure, rotation permission issues, missing log files

## ðŸ”§ Maintenance

### Regular Tasks

- Review daily Logwatch email reports for anomalies
- Monitor disk usage (ensure logs don't exceed threshold)
- Verify log rotation happening on schedule
- Check for unrotated logs exceeding size limits
- Archive critical security logs to separate storage

### Typical Updates

- Adjust Logwatch detail level if reports too verbose/sparse
- Add new log sources as services added (e.g., custom app logs)
- Increase retention period for compliance requirements
- Enable/disable specific log analysis filters
- Change email recipient if admin changes

### Log Retrieval

```bash
# View current logs
tail -f /var/log/syslog

# Search archived logs
zgrep "error" /var/log/syslog.1.gz

# Decompress log for analysis
gzip -d /var/log/syslog.2.gz
gzip /var/log/syslog.2

# Check oldest logs
ls -lht /var/log/ | tail -20

# Calculate log directory size
du -sh /var/log/
```

---

**Module Type:** Operations â€” Monitoring & Logging  
**Execution Order:** Tenth (10)  
**Profile Availability:** Basic, Standard, Advanced  
**Configuration:** Automatic with email delivery setup  
**Service Integration:** Logwatch, logrotate, cron, mail delivery

